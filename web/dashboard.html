<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Temps Réel - IDS ML</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .dashboard-container {
            padding: 20px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid #e0e0e0;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            border-radius: 3px;
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .metric-title {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 40px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 5px;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, var(--dark-color), #555);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .metric-subtitle {
            font-size: 14px;
            color: #777;
            font-weight: 500;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px currentColor;
        }
        
        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.1);
            }
        }
        
        .status-active { 
            background: #27ae60; 
            box-shadow: 0 0 15px #27ae60;
        }
        .status-warning { 
            background: #f39c12; 
            box-shadow: 0 0 15px #f39c12;
        }
        .status-critical { 
            background: #e74c3c; 
            box-shadow: 0 0 15px #e74c3c;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-legend {
            display: flex;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #666;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .traffic-chart-container {
            height: 250px;
            position: relative;
        }
        
        .alerts-feed {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }
        
        .alert-item {
            padding: 18px;
            border-left: 5px solid;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #f9f9f9, #f0f0f0);
            border-radius: 8px;
            animation: slideIn 0.4s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        
        .alert-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-critical { 
            border-left-color: #e74c3c; 
            background: linear-gradient(135deg, #ffe5e5, #ffd1d1);
        }
        .alert-high { 
            border-left-color: #f39c12; 
            background: linear-gradient(135deg, #fff3cd, #ffe8a4);
        }
        .alert-medium { 
            border-left-color: #3498db; 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }
        .alert-low { 
            border-left-color: #95a5a6; 
            background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .alert-title {
            font-weight: 700;
            color: var(--dark-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-time {
            font-size: 12px;
            color: #777;
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .alert-details {
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 14px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .badge-critical { 
            background: linear-gradient(135deg, #e74c3c, #c0392b); 
            color: white;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }
        .badge-high { 
            background: linear-gradient(135deg, #f39c12, #e67e22); 
            color: white;
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
        }
        .badge-medium { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }
        .badge-low { 
            background: linear-gradient(135deg, #95a5a6, #7f8c8d); 
            color: white;
            box-shadow: 0 2px 8px rgba(149, 165, 166, 0.3);
        }
        
        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            align-items: center;
            border: 1px solid #e0e0e0;
        }
        
        .btn-control {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            letter-spacing: 0.5px;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-control:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        
        .protocol-chart {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .protocol-bar {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 15px;
            position: relative;
            height: 140px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
            border: 2px solid #f0f0f0;
        }
        
        .protocol-fill {
            width: 80%;
            background: linear-gradient(to top, var(--primary-color), var(--secondary-color));
            border-radius: 8px;
            transition: height 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }
        
        .protocol-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(to top, rgba(255,255,255,0.1), rgba(255,255,255,0.3));
        }
        
        .protocol-label {
            margin-top: 15px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--dark-color);
            letter-spacing: 0.5px;
        }
        
        .protocol-value {
            position: absolute;
            top: 15px;
            font-weight: 800;
            color: var(--dark-color);
            font-size: 22px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .protocol-name {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }
        
        /* Scrollbar styling */
        .alerts-feed::-webkit-scrollbar {
            width: 8px;
        }
        
        .alerts-feed::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .alerts-feed::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ccc, #999);
            border-radius: 4px;
        }
        
        .alerts-feed::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #aaa, #777);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .traffic-chart-container {
                height: 220px;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .protocol-chart {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .protocol-bar {
                height: 100px;
            }
            
            .traffic-chart-container {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="index.html">
                        <i class="fas fa-shield-alt"></i>
                        <span>IDS ML - Dashboard Temps Réel</span>
                    </a>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="status-indicator status-active"></span>
                    <div style="display: flex; flex-direction: column;">
                        <span style="color: #27ae60; font-weight: 700; font-size: 14px;">SURVEILLANCE ACTIVE</span>
                        <span style="color: #666; font-size: 12px;">Monitoring en temps réel</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <div class="container">
            <!-- Controls -->
            <div class="controls">
                <button class="btn-control btn-start" id="startBtn">
                    <i class="fas fa-play-circle"></i> DÉMARRER SURVEILLANCE
                </button>
                <button class="btn-control btn-stop" id="stopBtn" style="display: none;">
                    <i class="fas fa-stop-circle"></i> ARRÊTER SURVEILLANCE
                </button>
                <div style="flex: 1;"></div>
                <div style="display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 8px 15px; border-radius: 25px;">
                    <i class="fas fa-sync-alt" style="color: var(--primary-color); animation: spin 2s linear infinite;"></i>
                    <span style="color: #666; font-weight: 500; font-size: 13px;">
                        Mise à jour automatique • 2 secondes
                    </span>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">PAQUETS ANALYSÉS</div>
                        <div class="metric-icon" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                            <i class="fas fa-network-wired" style="color: #2196f3;"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="totalPackets">0</div>
                    <div class="metric-subtitle">
                        <i class="fas fa-chart-line" style="color: #27ae60;"></i> 
                        <span id="packetsPerSec">0</span> paquets/sec • Temps réel
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">ATTAQUES DÉTECTÉES</div>
                        <div class="metric-icon" style="background: linear-gradient(135deg, #ffe5e5, #ffb8b8);">
                            <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="attacksDetected">0</div>
                    <div class="metric-subtitle">
                        <span class="status-indicator status-critical"></span>
                        <span id="criticalAlerts" style="color: #e74c3c; font-weight: 700;">0</span> ALERTES CRITIQUES
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">PRÉCISION DE DÉTECTION</div>
                        <div class="metric-icon" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            <i class="fas fa-chart-line" style="color: #4caf50;"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="detectionRate">97.5%</div>
                    <div class="metric-subtitle">
                        <i class="fas fa-microchip" style="color: #3498db;"></i> 
                        Modèles ML • Analyse continue
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-title">UPTIME SYSTÈME</div>
                        <div class="metric-icon" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            <i class="fas fa-clock" style="color: #ff9800;"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="uptime" style="font-size: 32px;">00:00:00</div>
                    <div class="metric-subtitle">
                        <i class="fas fa-server" style="color: #9b59b6;"></i> 
                        Surveillance active en continu
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px;">
                <!-- Traffic Timeline -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-line" style="color: #e74c3c;"></i>
                            TRAFIC RÉSEAU EN TEMPS RÉEL
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #e74c3c;"></div>
                                Paquets/Sec
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #3498db;"></div>
                                Moyenne (30s)
                            </div>
                        </div>
                    </div>
                    <div class="traffic-chart-container">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>

                <!-- Protocol Distribution -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">
                            <i class="fas fa-chart-pie" style="color: #3498db;"></i>
                            DISTRIBUTION DES PROTOCOLES
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-percentage"></i>
                            Pourcentage du trafic
                        </div>
                    </div>
                    <div class="protocol-chart">
                        <div class="protocol-bar">
                            <div class="protocol-name">TCP</div>
                            <div class="protocol-value" id="tcpCount">0</div>
                            <div class="protocol-fill" id="tcpBar" style="height: 0%;"></div>
                            <div class="protocol-label">TCP</div>
                        </div>
                        <div class="protocol-bar">
                            <div class="protocol-name">UDP</div>
                            <div class="protocol-value" id="udpCount">0</div>
                            <div class="protocol-fill" id="udpBar" style="height: 0%;"></div>
                            <div class="protocol-label">UDP</div>
                        </div>
                        <div class="protocol-bar">
                            <div class="protocol-name">AUTRE</div>
                            <div class="protocol-value" id="otherCount">0</div>
                            <div class="protocol-fill" id="otherBar" style="height: 0%;"></div>
                            <div class="protocol-label">AUTRE</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts Feed -->
            <div class="alerts-feed">
                <div class="chart-header" style="border-bottom: 2px solid #f0f0f0; margin-bottom: 20px;">
                    <div class="chart-title">
                        <i class="fas fa-bell" style="color: #f39c12;"></i>
                        FLUX D'ALERTES EN TEMPS RÉEL
                        <span class="badge badge-critical" id="alertCount">0</span>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="clearAlerts()" style="background: #f8f9fa; border: 2px solid #e9ecef; padding: 6px 15px; border-radius: 20px; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            <i class="fas fa-trash-alt"></i> Vider
                        </button>
                        <button onclick="pauseAlerts()" id="pauseBtn" style="background: #f8f9fa; border: 2px solid #e9ecef; padding: 6px 15px; border-radius: 20px; color: #666; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                    </div>
                </div>
                <div id="alertsFeed">
                    <div style="text-align: center; padding: 40px; color: #aaa; border-radius: 10px; background: #fafafa;">
                        <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="font-size: 16px; font-weight: 500; margin-bottom: 10px;">Aucune alerte détectée</p>
                        <p style="font-size: 14px; color: #999;">Les alertes de sécurité apparaîtront ici en temps réel</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Variables globales
        let monitoringActive = false;
        let startTime = null;
        let uptimeInterval = null;
        let socket = null;
        let chartData = [];
        let chartLabels = [];
        let alertsPaused = false;
        let movingAverage = [];
        let alertCounter = 0;
        
        // Configuration avancée du graphique
        const ctx = document.getElementById('trafficChart').getContext('2d');
        
        // Définir un gradient pour l'arrière-plan
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(231, 76, 60, 0.2)');
        gradient.addColorStop(1, 'rgba(231, 76, 60, 0.05)');
        
        // Configuration du graphique
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Paquets/Sec',
                        data: chartData,
                        borderColor: '#e74c3c',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#e74c3c',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#ffffff',
                        pointHoverBorderColor: '#e74c3c',
                        pointHoverBorderWidth: 3
                    },
                    {
                        label: 'Moyenne (30s)',
                        data: movingAverage,
                        borderColor: '#3498db',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 750,
                    easing: 'easeOutQuart'
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.05)',
                            borderColor: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#666',
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)',
                            borderColor: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            color: '#666',
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            callback: function(value) {
                                return value + '/s';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Paquets par seconde',
                            color: '#666',
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.7)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        cornerRadius: 6,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y} paquets/sec`;
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
        
        // Fonctions de contrôle
        document.getElementById('startBtn').addEventListener('click', startMonitoring);
        document.getElementById('stopBtn').addEventListener('click', stopMonitoring);
        
        // Initialize WebSocket connection
        function initializeWebSocket() {
            try {
                socket = io('http://localhost:5000');
                
                socket.on('connect', function() {
                    console.log('WebSocket connected');
                    document.querySelector('.status-indicator').className = 'status-indicator status-active';
                });
                
                socket.on('connection_status', function(data) {
                    console.log('Connection status:', data);
                    monitoringActive = data.monitoring_active;
                    
                    if (monitoringActive) {
                        document.getElementById('startBtn').style.display = 'none';
                        document.getElementById('stopBtn').style.display = 'inline-block';
                        startTime = new Date();
                        uptimeInterval = setInterval(updateUptime, 1000);
                        updateUptime();
                    }
                });
                
                socket.on('stats_update', function(data) {
                    updateDashboard(data);
                });
                
                socket.on('new_alert', function(alert) {
                    if (!alertsPaused) {
                        addAlert(alert);
                    }
                });
                
                socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                    document.querySelector('.status-indicator').className = 'status-indicator status-critical';
                });
                
                socket.on('connect_error', function(error) {
                    console.error('WebSocket connection error:', error);
                    document.querySelector('.status-indicator').className = 'status-indicator status-critical';
                    // Fallback to polling
                    setInterval(fetchStatsFallback, 2000);
                });
                
            } catch (error) {
                console.error('WebSocket initialization error:', error);
                // Fallback to polling
                setInterval(fetchStatsFallback, 2000);
            }
        }
        
        // Fallback si WebSocket échoue
        async function fetchStatsFallback() {
            if (!monitoringActive) return;
            
            try {
                const response = await fetch('/api/monitoring/stats');
                if (response.ok) {
                    const data = await response.json();
                    updateDashboard(data.stats);
                }
            } catch (error) {
                console.error('Fallback stats fetch error:', error);
            }
        }
        
        // Démarrer la connexion WebSocket au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            
            // Charger les stats initiales
            fetch('/api/monitoring/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.monitoring_active) {
                        updateDashboard(data.stats);
                        updateUptime();
                    }
                })
                .catch(error => console.error('Error fetching initial stats:', error));
        });
        
        function startMonitoring() {
            fetch('/api/monitoring/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    monitoringActive = true;
                    startTime = new Date(data.start_time ? new Date(data.start_time) : new Date());
                    
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    
                    // Réinitialiser les données du graphique
                    chartData = [];
                    chartLabels = [];
                    movingAverage = [];
                    trafficChart.data.labels = chartLabels;
                    trafficChart.data.datasets[0].data = chartData;
                    trafficChart.data.datasets[1].data = movingAverage;
                    trafficChart.update();
                    
                    // Réinitialiser le compteur d'alertes
                    alertCounter = 0;
                    
                    uptimeInterval = setInterval(updateUptime, 1000);
                    
                    console.log('Surveillance démarrée');
                }
            })
            .catch(error => console.error('Error starting monitoring:', error));
        }
        
        function stopMonitoring() {
            fetch('/api/monitoring/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    monitoringActive = false;
                    
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';
                    
                    clearInterval(uptimeInterval);
                    
                    console.log('Surveillance arrêtée');
                }
            })
            .catch(error => console.error('Error stopping monitoring:', error));
        }
        
        function updateUptime() {
            if (!startTime) return;
            
            const now = new Date();
            const diff = now - startTime;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function updateDashboard(data) {
            // Mettre à jour les métriques avec animations
            animateCounter('totalPackets', data.total_packets);
            animateCounter('packetsPerSec', data.packets_per_second.toFixed(1));
            animateCounter('attacksDetected', data.attacks_detected);
            animateCounter('criticalAlerts', data.critical_alerts);
            
            // Mettre à jour le graphique
            const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            chartLabels.push(now);
            chartData.push(data.packets_per_second);
            
            // Calculer la moyenne mobile sur 30 secondes (15 points à 2s d'intervalle)
            const windowSize = 15;
            if (chartData.length >= windowSize) {
                const windowData = chartData.slice(-windowSize);
                const average = windowData.reduce((a, b) => a + b, 0) / windowData.length;
                movingAverage.push(average);
            } else {
                movingAverage.push(data.packets_per_second);
            }
            
            // Limiter à 60 points pour une meilleure lisibilité
            if (chartLabels.length > 60) {
                chartLabels.shift();
                chartData.shift();
                movingAverage.shift();
            }
            
            // Mettre à jour le graphique avec animation
            trafficChart.data.labels = chartLabels;
            trafficChart.data.datasets[0].data = chartData;
            trafficChart.data.datasets[1].data = movingAverage;
            trafficChart.update();
            
            // Mettre à jour les protocoles
            updateProtocolBars(data.protocols);
            
            // Mettre à jour le taux de détection (simulation)
            const detectionRate = 97.5 + (Math.random() * 1 - 0.5);
            document.getElementById('detectionRate').textContent = detectionRate.toFixed(1) + '%';
        }
        
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            const currentValue = parseFloat(element.textContent.replace(/,/g, '')) || 0;
            const target = parseFloat(targetValue);
            
            if (currentValue === target) return;
            
            const duration = 500; // ms
            const start = Date.now();
            const increment = (target - currentValue) / duration * 10;
            
            function update() {
                const elapsed = Date.now() - start;
                if (elapsed >= duration) {
                    element.textContent = formatNumber(target);
                    return;
                }
                
                const newValue = currentValue + increment * elapsed;
                element.textContent = formatNumber(newValue);
                requestAnimationFrame(update);
            }
            
            update();
        }
        
        function formatNumber(value) {
            if (typeof value === 'number') {
                if (value >= 1000) {
                    return value.toLocaleString('fr-FR');
                }
                return value.toFixed(1);
            }
            return value;
        }
        
        function updateProtocolBars(protocols) {
            const total = protocols.tcp + protocols.udp + protocols.other;
            
            if (total > 0) {
                // TCP
                const tcpPercent = (protocols.tcp / total * 100);
                document.getElementById('tcpCount').textContent = protocols.tcp.toLocaleString();
                document.getElementById('tcpBar').style.height = `${tcpPercent}%`;
                document.getElementById('tcpBar').style.background = 'linear-gradient(to top, #e74c3c, #ff6b6b)';
                
                // UDP
                const udpPercent = (protocols.udp / total * 100);
                document.getElementById('udpCount').textContent = protocols.udp.toLocaleString();
                document.getElementById('udpBar').style.height = `${udpPercent}%`;
                document.getElementById('udpBar').style.background = 'linear-gradient(to top, #3498db, #1abc9c)';
                
                // Other
                const otherPercent = (protocols.other / total * 100);
                document.getElementById('otherCount').textContent = protocols.other.toLocaleString();
                document.getElementById('otherBar').style.height = `${otherPercent}%`;
                document.getElementById('otherBar').style.background = 'linear-gradient(to top, #9b59b6, #e74c3c)';
            }
        }
        
        function addAlert(alert) {
            alertCounter++;
            document.getElementById('alertCount').textContent = alertCounter;
            
            const feed = document.getElementById('alertsFeed');
            
            // Supprimer le message d'attente
            if (feed.children.length === 1 && feed.children[0].tagName === 'DIV' && 
                feed.children[0].querySelector('i.fa-bell-slash')) {
                feed.innerHTML = '';
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item alert-${alert.severity}`;
            alertDiv.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">
                        <span class="badge badge-${alert.severity}">${alert.severity.toUpperCase()}</span>
                        <i class="fas fa-${getAlertIcon(alert.type)}"></i>
                        ${alert.type}
                    </div>
                    <div class="alert-time">${alert.timestamp}</div>
                </div>
                <div class="alert-details">
                    <i class="fas fa-network-wired"></i> Source: ${alert.source_ip} → ${alert.destination_ip || 'Cible'}
                    <br>
                    <i class="fas fa-chart-bar"></i> Confiance: <strong>${(alert.confidence * 100).toFixed(0)}%</strong>
                    ${alert.protocol ? `• Protocole: <strong>${alert.protocol}</strong>` : ''}
                </div>
            `;
            
            // Effet de son si alerte critique
            if (alert.severity === 'critical' && !alertsPaused) {
                playAlertSound();
            }
            
            feed.insertBefore(alertDiv, feed.firstChild);
            
            // Limiter le nombre d'alertes affichées
            while (feed.children.length > 50) {
                feed.removeChild(feed.lastChild);
            }
            
            // Mettre en évidence temporaire
            setTimeout(() => {
                alertDiv.style.background = 'linear-gradient(135deg, #f9f9f9, #f0f0f0)';
            }, 2000);
        }
        
        function getAlertIcon(alertType) {
            const icons = {
                'DoS': 'bolt',
                'Port Scan': 'search',
                'Brute Force': 'key',
                'SQL Injection': 'database',
                'DDoS': 'cloud-bolt',
                'R2L': 'user-shield',
                'U2R': 'user-cog',
                'Botnet': 'robot',
                'Exfiltration': 'file-export'
            };
            return icons[alertType] || 'exclamation-triangle';
        }
        
        function playAlertSound() {
            // Créer un son d'alerte simple
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio context not supported');
            }
        }
        
        function clearAlerts() {
            const feed = document.getElementById('alertsFeed');
            feed.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #aaa; border-radius: 10px; background: #fafafa;">
                    <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p style="font-size: 16px; font-weight: 500; margin-bottom: 10px;">Aucune alerte détectée</p>
                    <p style="font-size: 14px; color: #999;">Les alertes de sécurité apparaîtront ici en temps réel</p>
                </div>
            `;
            alertCounter = 0;
            document.getElementById('alertCount').textContent = '0';
        }
        
        function pauseAlerts() {
            const pauseBtn = document.getElementById('pauseBtn');
            alertsPaused = !alertsPaused;
            
            if (alertsPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> Reprendre';
                pauseBtn.style.background = 'linear-gradient(135deg, #27ae60, #219653)';
                pauseBtn.style.color = 'white';
                pauseBtn.style.borderColor = '#27ae60';
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                pauseBtn.style.background = '#f8f9fa';
                pauseBtn.style.color = '#666';
                pauseBtn.style.borderColor = '#e9ecef';
            }
        }
    </script>
</body>
</html>